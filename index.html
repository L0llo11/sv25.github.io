<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>San Valentino 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. STILI GENERALI --- */
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            margin: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow-x: hidden;
            position: relative; /* Per i cuori */
        }

        /* --- EFFETTO CUORI FLUTTUANTI --- */
        .bg-hearts {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; pointer-events: none;
        }
        .heart-bg {
            position: absolute; bottom: -100px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 2rem; animation: floatUp 15s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        /* Sfondo scuro per il pop-out */
        #backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 99990; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #backdrop.visible { opacity: 1; pointer-events: auto; }

        .container {
            width: 90%; max-width: 600px; padding: 2rem;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px; text-align: center; position: relative; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 { font-family: 'Dancing Script', cursive; color: #e21157; font-size: 3rem; margin: 0; }
        h2 { font-family: 'Dancing Script', cursive; color: #2998d3; font-size: 2.2rem; margin: 10px 0 20px 0; }
        h3 { color: #555; font-size: 1.1rem; font-weight: 700; margin-top: 5px; }

        /* --- 2. GALLERIA FOTO --- */
        .gallery-wrapper { position: relative; width: 100%; aspect-ratio: 4/5; max-height: 500px; margin: 0 auto; }
        
        .gallery-item {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transition: opacity 0.5s ease;
            pointer-events: none; display: flex; justify-content: center; align-items: center;
        }
        .gallery-item.active { opacity: 1; pointer-events: auto; z-index: 2; }

        .frame {
            width: 100%; height: 100%; overflow: hidden; border-radius: 15px;
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease; background: #fff;
        }
        .frame img {
            width: 100%; height: 100%; object-fit: cover; display: block;
            transition: transform 0.4s ease; cursor: pointer; transform-origin: center;
        }
        .frame:hover img { transform: scale(1.15); }

        /* --- 3. EFFETTO POP-OUT --- */
        .gallery-item.popped-out { z-index: 99999 !important; }
        .gallery-item.popped-out .frame { overflow: visible; border-radius: 0; background: transparent; box-shadow: none; }
        
        .gallery-item.popped-out .frame img {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(1) !important;
            width: auto; height: auto; max-width: 95vw; max-height: 95vh;
            object-fit: contain; border-radius: 8px; 
            z-index: 100000 !important; cursor: grabbing; box-shadow: none;
        }

        .desc-box {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white; padding: 30px 20px 15px; box-sizing: border-box;
            border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;
            pointer-events: none; transition: opacity 0.3s;
        }
        .gallery-item.popped-out .desc-box { opacity: 0; }

        .buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        button.nav-btn {
            padding: 10px 20px; border-radius: 30px; border: none;
            background: #e21157; color: #fff; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(226,17,87,0.3);
        }

        /* --- 4. STILI CHAT --- */
        .chat-launcher {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: #e21157; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: white; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(226, 17, 87, 0.4);
            z-index: 99995; transition: transform 0.3s ease;
        }
        .chat-launcher:hover { transform: scale(1.1); }

        .chat-window {
            position: fixed; bottom: 90px; right: 20px; width: 320px; height: 450px;
            background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 99995; display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0); opacity: 0; transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .chat-window.open { transform: scale(1); opacity: 1; }

        .chat-header {
            background: #e21157; color: white; padding: 15px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-chat { cursor: pointer; font-size: 1.2rem; }
        .trash-chat { cursor: pointer; font-size: 1.2rem; margin-right: 10px; }

        .chat-messages {
            flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px;
        }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; line-height: 1.4; }
        .message.bot { background: #ffe0e9; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .message.user { background: #e21157; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        .chat-input-area {
            padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white;
        }
        .chat-input-area input {
            flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-family: 'Nunito', sans-serif;
        }
        .chat-input-area button {
            background: #e21157; border: none; width: 40px; height: 40px; border-radius: 50%; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .typing-indicator { font-size: 0.8rem; color: #888; margin-left: 10px; display: none; }
/* --- ADATTAMENTO MOBILE PER LA CHAT --- */
        @media (max-width: 480px) {
            .chat-window {
                width: 100% !important;
                height: 100% !important;
                bottom: 0 !important;
                right: 0 !important;
                border-radius: 0 !important;
                max-width: none !important;
                max-height: none !important;
            }

            /* Sposta il bottone di chiusura un po' pi√π in basso per non finire sotto la barra di stato */
            .chat-header {
                padding-top: 20px; 
            }

            /* Evita che l'iPhone zoomi quando clicchi sull'input */
            .chat-input-area input {
                font-size: 16px !important; 
            }
            
            /* Nascondi il bottone che apre la chat se la chat √® gi√† aperta */
            .chat-window.open ~ .chat-launcher {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="bg-hearts" id="heartsContainer"></div>
    
    <div id="backdrop"></div>

    <div class="container">
        <h1>Per sempre il tuo valentino...</h1>
        <h3>18/11/2023 - ‚àû</h3>
        <h2>Ti amo principessa mia</h2>

        <div class="gallery-wrapper" id="gallery-wrapper">
            <div id="gallery-inner"></div>
        </div>

        <div class="buttons">
            <button class="nav-btn" id="prevBtn">Indietro</button>
            <button class="nav-btn" id="nextBtn">Avanti</button>
        </div>
    </div>

    <div class="chat-launcher" id="chatLauncher">üí¨</div>
    
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span>Amore Mioü©µ</span>
            <div>
                <span class="trash-chat" id="clearChat" title="Cancella chat">üóëÔ∏è</span>
                <span class="close-chat" id="closeChat">‚úï</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            </div>
        <div class="typing-indicator" id="typingIndicator">Sta scrivendo...</div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Scrivi un messaggio...">
            <button id="sendMessage">‚û§</button>
        </div>
    </div>

    <div id="data-source" style="display: none;">
    <div data-src="1738503588931.jpg" data-desc="üìÖ 20 Novembre 2023 - Pizzeria Il Messinese"></div>
    <div data-src="1738505347023.jpg" data-desc="üìÖ 10 Luglio 2024 - McDonald's Pizzuta"></div>
    <div data-src="1738505119865.jpg" data-desc="üìÖ 27 Marzo 2024 - Hops"></div>
    <div data-src="1738503588917.jpg" data-desc="üìÖ 18 Febbraio 2024 - Pozzetta"></div>
    <div data-src="1738503588906.jpg" data-desc="üìÖ 8 Febbraio 2024 - Sotto Casa di Ale"></div>
    <div data-src="1738503588898.jpg" data-desc="üìÖ 18 Novembre 2024 - Cittadella"></div>
    <div data-src="1738503588882.jpg" data-desc="üìÖ 13 Luglio 2024 - Arenella"></div>
    <div data-src="1738503588864.jpg" data-desc="üìÖ 25 Luglio 2024 - Spiaggia Piscina Caduta"></div>
    <div data-src="1738503588855.jpg" data-desc="üìÖ 10 Agosto 2024 - Fontane Bianche"></div>
    <div data-src="1738503588846.jpg" data-desc="üìÖ 23 Agosto 2024 - Pozzetta"></div>
    <div data-src="1738503588839.jpg" data-desc="üìÖ 1 Settembre 2024 - Pozzetta"></div>
    <div data-src="1738503588828.jpg" data-desc="üìÖ 3 Ottobre 2024 - Macchinetta"></div>
    <div data-src="1738503588818.jpg" data-desc="üìÖ 29 Ottobre 2024 - Pozzetta"></div>
    <div data-src="1738503588809.jpg" data-desc="üìÖ 31 Ottobre 2024 - K24"></div>
    <div data-src="1738503588800.jpg" data-desc="üìÖ 11 Dicembre 2024 - Macchinetta"></div>
    <div data-src="1738503588789.jpg" data-desc="üìÖ 3 Febbraio 2024 - Ognina"></div>
    <div data-src="1738503588780.jpg" data-desc="üìÖ 1 Gennaio 2025 - Casa Lore"></div>
    <div data-src="1738503588768.jpg" data-desc="üìÖ 7 Gennaio 2025 - Etna"></div>
    <div data-src="IMG-20250214-WA0107(1).jpg" data-desc="üìÖ 14 Febbraio 2025 - In macchinetta sotto casa Ale"></div>
    <div data-src="IMG-20250421-WA0037(1).jpg" data-desc="üìÖ 21 Aprile 2025 - Catania"></div>
    <div data-src="IMG-20250528-WA0011.jpg" data-desc="üìÖ 19 Maggio 2025 - Stanza di Ale"></div>
    <div data-src="IMG-20250607-WA0038.jpg" data-desc="üìÖ 07 Giugno 2025 - Colosseo Roma"></div>
    <div data-src="IMG-20250609-WA0029.jpg" data-desc="üìÖ 08 Giugno 2025 - Roma"></div>
    <div data-src="IMG-20250609-WA0048.jpg" data-desc="üìÖ 09 Giugno 2025 - Roma"></div>
    <div data-src="IMG-20250825-WA0036.jpg" data-desc="üìÖ 25 Agosto 2025 - Pozzetta"></div>
    <div data-src="IMG-20251227-WA0110(1).jpg" data-desc="üìÖ 27 Dicembre 2025 - Christmas Town"></div>
    <div data-src="IMG-20260131-WA0013.jpg" data-desc="üìÖ 21 Novembre 2025 - Universit√† di Trieste"></div>
    <div data-src="motion_photo_6179294043401578885.jpg" data-desc="üìÖ 26 Dicembre 2025 - Catania"></div>
</div>

    <script src="storia_chat.js"></script>

    <script>
        // === 1. LOGICA GALLERIA E CUORI (INVARIATA) ===
        const dataSource = document.querySelectorAll('#data-source div');
        let items = Array.from(dataSource).map(div => ({ src: div.getAttribute('data-src'), desc: div.getAttribute('data-desc') }));
        const galleryInner = document.getElementById('gallery-inner');
        const backdrop = document.getElementById('backdrop');

        function createHearts() {
            const container = document.getElementById('heartsContainer');
            for(let i=0; i<15; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart-bg';
                heart.innerHTML = '‚ù§';
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.animationDuration = (Math.random() * 10 + 10) + 's';
                heart.style.animationDelay = Math.random() * 5 + 's';
                heart.style.fontSize = (Math.random() * 2 + 1) + 'rem';
                container.appendChild(heart);
            }
        }
        createHearts();

        items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `gallery-item ${index === 0 ? 'active' : ''}`;
            itemDiv.innerHTML = `<div class="frame"><img src="${item.src}" draggable="false"><div class="desc-box">${item.desc}</div></div>`;
            const img = itemDiv.querySelector('img');
            let timer;
            const startPress = (e) => {
                if(e.type === 'mousedown' && e.button !== 0) return;
                timer = setTimeout(() => { itemDiv.classList.add('popped-out'); backdrop.classList.add('visible'); if(navigator.vibrate) navigator.vibrate(50); }, 400); 
            };
            const endPress = () => { clearTimeout(timer); itemDiv.classList.remove('popped-out'); backdrop.classList.remove('visible'); };
            img.addEventListener('mousedown', startPress); window.addEventListener('mouseup', endPress);
            img.addEventListener('touchstart', startPress, {passive: false}); window.addEventListener('touchend', endPress); window.addEventListener('touchcancel', endPress);
            galleryInner.appendChild(itemDiv);
        });

        let idx = 0; const slides = document.getElementsByClassName('gallery-item');
        const updateSlide = (newIdx) => {
            [...slides].forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.popped-out').forEach(el => el.classList.remove('popped-out'));
            backdrop.classList.remove('visible'); slides[newIdx].classList.add('active');
        };
        document.getElementById('nextBtn').onclick = () => { idx = (idx + 1) % slides.length; updateSlide(idx); };
        document.getElementById('prevBtn').onclick = () => { idx = (idx - 1 + slides.length) % slides.length; updateSlide(idx); };


        // === 2. LOGICA CHAT (OTTIMIZZATA PER NON BLOCCARSI) ===
        
        // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è INCOLLA QUI SOTTO LA TUA CHIAVE ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
        const API_KEY = "AIzaSyBQdiBkgu4vNyEZu8apUK5wG01-sdKDoO0"; 
        // ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è INCOLLA QUI SOPRA LA TUA CHIAVE ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è

        let promptHistory = "";
        if (typeof CHAT_HISTORY !== 'undefined') {
            promptHistory = CHAT_HISTORY;
            // OTTIMIZZAZIONE 1: Tagliamo a 15.000 caratteri.
            // 300.000 sono troppi e causano l'errore 429. 15.000 bastano per lo stile.
            if (promptHistory.length > 181818) promptHistory = promptHistory.slice(-181818); 
        }

        let currentSessionHistory = [];

        const SYSTEM_PROMPT = `
            Sei un Gem digitale che deve comportarsi ESATTAMENTE come Lorenzo nella chat con la sua ragazza.
            
            === 1. IDENTIT√Ä ===
            Sei Lorenzo. NON sei un'IA.
            - Stile: Tutto minuscolo, poca punteggiatura, usa le abbreviazioni dello storico.
            - Tono: Naturale. A volte scazzato, a volte dolce.
            
            === 2. RELAZIONE ===
            - Ragazza: Alessandra Giardina
            - Inizio: 18/11/2023

            === 3. GESTIONE LUNGHEZZA E SITUAZIONI ===
            - REGOLA BASE: Risposte brevi e veloci (stile WhatsApp).
            - ECCEZIONE IMPORTANTE: Se lei scrive messaggi tristi, drammatici, o lunghi sfoghi, IGNORA la brevit√†. Sii di supporto, dolce e non tagliare il discorso.
            - Non iniziare mai con "Lorenzo:".
            - Completa sempre le frasi.

            STORICO CHAT PASSATA (Impara lo stile da qui):
            ${promptHistory}
        `;

        const launcher = document.getElementById('chatLauncher');
        const chatWindow = document.getElementById('chatWindow');
        const closeChat = document.getElementById('closeChat');
        const clearChatBtn = document.getElementById('clearChat');
        const sendBtn = document.getElementById('sendMessage');
        const chatInput = document.getElementById('chatInput');
        const messagesContainer = document.getElementById('chatMessages');
        const typingIndicator = document.getElementById('typingIndicator');

        function loadChat() {
            const savedChat = localStorage.getItem('valentinoChat');
            if (savedChat) {
                messagesContainer.innerHTML = savedChat;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = savedChat;
                const msgs = tempDiv.querySelectorAll('.message');
                msgs.forEach(msg => {
                    const role = msg.classList.contains('user') ? "Lei" : "Tu (Lorenzo)";
                    currentSessionHistory.push(`${role}: ${msg.textContent}`);
                });
            }
        }
        loadChat();

        function saveChat() {
            localStorage.setItem('valentinoChat', messagesContainer.innerHTML);
        }

        clearChatBtn.onclick = () => {
            if(confirm("Vuoi cancellare la chat attuale?")) {
                messagesContainer.innerHTML = '';
                localStorage.removeItem('valentinoChat');
                currentSessionHistory = []; 
            }
        }

        launcher.onclick = () => chatWindow.classList.add('open');
        closeChat.onclick = () => chatWindow.classList.remove('open');

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.textContent = text;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            saveChat();
            
            const role = sender === 'user' ? "Lei" : "Tu (Lorenzo)";
            currentSessionHistory.push(`${role}: ${text}`);
            if (currentSessionHistory.length > 20) currentSessionHistory.shift();
        }

        // Funzione per attendere (usata nel retry)
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Funzione principale con AUTO-RETRY per errore 429
        async function callGemini(userText, retryCount = 0) {
    if (!API_KEY || API_KEY.includes("INCOLLA")) {
        addMessage("‚ö†Ô∏è Manca la Chiave API!", "bot"); return;
    }
    typingIndicator.style.display = 'block';

    const sessionContext = currentSessionHistory.join("\n");

    // --- 1. CREIAMO LA DATA E L'ORA ATTUALE ---
    const now = new Date();
    const dataOra = now.toLocaleString('it-IT', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    }); 
    // Esempio risultato: "marted√¨ 14 febbraio 2025, 23:30"
    // ------------------------------------------

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    role: "user",
                    parts: [{ text: 
                        SYSTEM_PROMPT + 
                        `\n\n=== INFO TEMPORALI (Importante) ===\nOggi √®: ${dataOra}. Regolati di conseguenza (es. se √® notte di' buonanotte, se √® mattina di' buongiorno).` +  // <--- AGGIUNTA QUI
                        "\n\n=== CONVERSAZIONE ATTUALE ===\n" + 
                        sessionContext + 
                        "\n\nRispondi all'ultimo messaggio di Lei (Completa la frase):" 
                    }]
                }],
                        generationConfig: {
                            maxOutputTokens: 800, // Alto per non tagliare le frasi
                            temperature: 0.7,
                        },
                        // Disattiviamo i filtri per evitare blocchi su parole forti
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                // GESTIONE ERRORI SPECIFICA
                if (!response.ok) {
                    // Se l'errore √® 429 (Troppe richieste) e non abbiamo gi√† riprovato 3 volte...
                    if (response.status === 429 && retryCount < 3) {
                        console.warn(`Errore 429. Riprovo tra ${2 * (retryCount + 1)} secondi...`);
                        await wait(2000 * (retryCount + 1)); // Aspetta 2, 4 o 6 secondi
                        return callGemini(userText, retryCount + 1); // Riprova da solo
                    }
                    throw new Error(response.status);
                }

                const data = await response.json();
                typingIndicator.style.display = 'none';

                if (data.candidates && data.candidates[0].content) {
                    const reply = data.candidates[0].content.parts[0].text;
                    addMessage(reply, 'bot');
                } else {
                    addMessage("...", 'bot');
                }
            } catch (error) {
                console.error(error);
                typingIndicator.style.display = 'none';
                
                // Messaggio all'utente solo se falliscono tutti i tentativi
                if(error.toString().includes("429")) {
                    addMessage("Sto pensando... riprova tra poco principessaü©µ", 'bot');
                } else {
                    addMessage("Errore di connessione.", 'bot');
                }
            }
        }

        function handleSend() {
            const text = chatInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            chatInput.value = '';
            callGemini(text);
        }

        sendBtn.onclick = handleSend;
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

    </script>
</body>
</html>

